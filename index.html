<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurant Star Ratings</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 10px;
    background: #fafafa;
  }
  h2 {
    font-size: 1.4em;
    margin-bottom: 15px;
  }
  .restaurant-card {
    background: white;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .restaurant-name {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 6px;
  }
  .rating-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 3px 0;
    font-size: 0.95em;
  }
  .label {
    flex: 0 0 70px;
    text-align: left;
  }
  .stars {
    position: relative;
    display: inline-block;
    font-size: 16px;
    color: #ccc; /* empty stars */
  }
  .stars::before {
    content: "★★★★★";
    position: absolute;
    top: 0;
    left: 0;
    width: var(--percent);
    overflow: hidden;
  }
  .stars-julie::before { color: #66c2a5; }
  .stars-stephen::before { color: #fc8d62; }
  .stars-dasan::before { color: #8da0cb; }
  .stars-avg::before { color: gold; }

  /* Top 3 Highlights */
  .rank-1 { border-left: 5px solid #FFD700; }
  .rank-2 { border-left: 5px solid #C0C0C0; }
  .rank-3 { border-left: 5px solid #CD7F32; }
</style>
</head>
<body>

<h2>Morristown Restaurant Ratings (Ranked)</h2>
<div id="ratings-container">Loading ratings...</div>

<script>
  const SHEET_JSON_URL = "https://docs.google.com/spreadsheets/d/1PLjQubtHRFGz887IxDJdiF0Y19tnmOdTAeyBNvyGMZg/gviz/tq?tqx=out:json";

  async function fetchData() {
    const response = await fetch(SHEET_JSON_URL);
    const text = await response.text();
    const json = JSON.parse(text.substr(47).slice(0, -2));
    
    return json.table.rows.map(row => ({
      name: row.c[0]?.v || "",
      stephen: parseFloat(row.c[1]?.v) || 0,
      julie: parseFloat(row.c[2]?.v) || 0,
      dasan: parseFloat(row.c[3]?.v) || 0
    }));
  }

  function createStars(score, personClass) {
    const percent = (score / 5) * 100;
    return `<span class="stars ${personClass}" style="--percent:${percent}%">★★★★★</span> (${score.toFixed(1)})`;
  }

  function calculateAverage(r) {
    const ratings = [r.stephen, r.julie, r.dasan].filter(val => val > 0);
    if (ratings.length === 0) return 0;
    return ratings.reduce((a, b) => a + b, 0) / ratings.length;
  }

  async function renderRatings() {
    let restaurants = await fetchData();

    restaurants = restaurants.map(r => ({
      ...r,
      avg: calculateAverage(r)
    }));

    restaurants.sort((a, b) => b.avg - a.avg);

    const container = document.getElementById("ratings-container");
    container.innerHTML = "";

    restaurants.forEach((r, index) => {
      const rankClass = index === 0 ? "rank-1" : index === 1 ? "rank-2" : index === 2 ? "rank-3" : "";
      const card = document.createElement("div");
      card.className = `restaurant-card ${rankClass}`;
      card.innerHTML = `
        <div class="restaurant-name">${r.name}</div>
        <div class="rating-row"><span class="label">Julie</span>${r.julie ? createStars(r.julie, "stars-julie") : "-"}</div>
        <div class="rating-row"><span class="label">Stephen</span>${r.stephen ? createStars(r.stephen, "stars-stephen") : "-"}</div>
        <div class="rating-row"><span class="label">Dasan</span>${r.dasan ? createStars(r.dasan, "stars-dasan") : "-"}</div>
        <div class="rating-row"><span class="label">Average</span>${r.avg ? createStars(r.avg, "stars-avg") : "-"}</div>
      `;
      container.appendChild(card);
    });
  }

  renderRatings();
</script>

</body>
</html>
